<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Sniper J GM 模擬器 v0.7.9</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f2f2f2; }
    h1 { color: #2c3e50; }
    button { margin: 5px; padding: 10px; font-size: 16px; border-radius: 5px; cursor: pointer; }
    .player { background: white; margin: 10px 0; padding: 10px; border-radius: 6px; display: flex; align-items: center; justify-content: space-between; }
    .player-info { flex-grow: 1; }
    .section { margin-top: 30px; }
    select { padding: 5px 10px; margin-top: 10px; }
    .container { max-width: 900px; margin: auto; }
    .stars { font-size: 14px; color: gold; }
    .checkbox { margin-left: 10px; }
    .warning { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🏀 Sniper J GM 模擬器 v0.7.9</h1>
    <div>
      <button id="clearBtn">清空存檔</button>
      <span id="dateDisplay"></span>
      <div id="moneyDisplay"></div>
    </div>
    <div class="section">
      <button id="showWarriorsBtn">勇士陣容</button>
      <button id="showFreeAgentsBtn">自由市場</button>
      <button id="selectTeamBtn">其他隊伍</button>
      <button id="simulateGameBtn">模擬比賽</button>
      <button id="resetTrainingBtn">重置訓練</button>
    </div>
    <div id="teamSelectArea"></div>
    <div id="team"></div>
    <div id="freeAgents"></div>
    <div id="otherTeam"></div>
    <div id="tradeZone"></div>
    <div id="gameResult"></div>
  </div>
  <script>
(() => {
  const ratingMap = { "C":1, "C+":2, "B-":3, "B":4, "B+":5, "A-":6, "A":7, "A+":8, "S":9, "S+":10 };
  const ratingStars = r => "★".repeat(Math.min(5, Math.round((ratingMap[r] || 1) / 2)));

  let warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, picks;

  function defaultData() {
    return {
      warriors: [
        { name:"Stephen Curry", rating:"S", salary:35, trainedToday:false },
        { name:"Klay Thompson", rating:"B+", salary:20, trainedToday:false },
        { name:"Draymond Green", rating:"B", salary:18, trainedToday:false },
        { name:"Jonathan Kuminga", rating:"B", salary:15, trainedToday:false },
        { name:"Andrew Wiggins", rating:"B+", salary:22, trainedToday:false },
        { name:"Moses Moody", rating:"C+", salary:10, trainedToday:false }
      ],
      freeAgents: [
        { name:"Malik Beasley", rating:"B", salary:15, signChance:60 },
        { name:"Robert Covington", rating:"B-", salary:12, signChance:50 }
      ],
      otherTeams: {
        "雷霆": [
          { name:"Shai Gilgeous-Alexander", rating:"S", salary:34 },
          { name:"Jalen Williams", rating:"A", salary:20 },
          { name:"Chet Holmgren", rating:"A-", salary:18 }
        ],
        "灰狼": [
          { name:"Anthony Edwards", rating:"S", salary:32 },
          { name:"Karl-Anthony Towns", rating:"A", salary:28 },
          { name:"Rudy Gobert", rating:"B+", salary:25 }
        ],
        "金塊": [
          { name:"Nikola Jokic", rating:"S+", salary:38 },
          { name:"Jamal Murray", rating:"A", salary:27 },
          { name:"Aaron Gordon", rating:"B+", salary:24 }
        ]
      },
      money: 100,
      salaryCap: 120,
      lastSimDate: null,
      picks: 1
    };
  }

  function loadData() {
    try {
      const saved = JSON.parse(localStorage.getItem("sj_gm_data") || "null");
      if (saved && saved.warriors && saved.freeAgents && saved.otherTeams) {
        ({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, picks } = saved);
        if (picks === undefined) picks = 1;
      } else {
        throw new Error("重建資料");
      }
    } catch {
      ({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, picks } = defaultData());
      saveData();
    }
  }

  function saveData() {
    localStorage.setItem("sj_gm_data", JSON.stringify({ warriors, freeAgents, otherTeams, money, salaryCap, lastSimDate, picks }));
  }

  function renderDate() {
    const now = new Date().toLocaleDateString();
    const teamSalary = getTeamSalary();
    const warning = teamSalary > salaryCap ? " ⚠️" : "";
    document.getElementById("dateDisplay").textContent = "｜今天：" + now;
    document.getElementById("moneyDisplay").innerHTML = `｜資金：$${money}M｜團隊工資：${teamSalary}M / 上限：${salaryCap}M${warning}｜首輪籤：${picks}`;
  }

  function getTeamSalary() {
    return warriors.reduce((sum, p) => sum + (p.salary || 0), 0);
  }

  function showWarriors() {
    const container = document.getElementById("team");
    container.innerHTML = "<h2>勇士隊陣容</h2>";
    warriors.forEach((p, i) => {
      const trained = p.trainedToday ? "（已訓練）" : "";
      const div = document.createElement("div");
      div.className = "player";
      div.innerHTML = `
        <div class="player-info">
          <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)} ${trained}<br/>
          💰 ${p.salary}M
          <input class="checkbox" type="checkbox" data-team="warriors" data-index="${i}"> 加入交易
        </div>
        <div>
          <button ${p.trainedToday ? 'disabled' : ''} onclick="trainPlayer(${i})">訓練</button>
          <button onclick="releasePlayer(${i})">釋出</button>
        </div>`;
      container.appendChild(div);
    });
  }

  window.trainPlayer = function(index) {
    const p = warriors[index];
    if (!p.trainedToday && ratingMap[p.rating] < 10) {
      const nextRating = Object.keys(ratingMap)[Object.values(ratingMap).indexOf(ratingMap[p.rating] + 1)];
      p.rating = nextRating;
      p.trainedToday = true;
      alert(`${p.name} 評價提升為 ${p.rating}！`);
    } else {
      alert("已訓練過或已達頂級！");
    }
    saveData();
    showWarriors();
  }

  window.releasePlayer = function(index) {
    const p = warriors[index];
    if (confirm(`確定釋出 ${p.name}？此操作無法復原。`)) {
      warriors.splice(index, 1);
      saveData();
      showWarriors();
      renderDate();
    }
  }
  function showFreeAgents() {
    const container = document.getElementById("freeAgents");
    container.innerHTML = "<h2>自由市場</h2>";
    freeAgents.forEach((p, i) => {
      const div = document.createElement("div");
      div.className = "player";
      div.innerHTML = `
        <div class="player-info">
          <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}<br/>
          💰 ${p.salary}M ｜簽約機率：${p.signChance}%
        </div>
        <div>
          <button onclick="signPlayer(${i})">簽下</button>
        </div>`;
      container.appendChild(div);
    });
  }

  window.signPlayer = function(index) {
    const p = freeAgents[index];
    if (getTeamSalary() + p.salary > salaryCap) return alert("超出工資上限！");
    if (money < p.salary) return alert("資金不足！");
    const chance = Math.random() * 100;
    if (chance <= p.signChance) {
      warriors.push({ ...p, trainedToday: false });
      freeAgents.splice(index, 1);
      money -= p.salary;
      alert(`${p.name} 成功加入！`);
    } else {
      alert(`${p.name} 拒絕加入...`);
    }
    saveData();
    renderDate();
    showFreeAgents();
    showWarriors();
  }

  function selectTeam() {
    const area = document.getElementById("teamSelectArea");
    area.innerHTML = `<h3>選擇球隊：</h3>
      <select id="teamSelect">
        <option value="">請選擇</option>
        ${Object.keys(otherTeams).map(t => `<option value="${t}">${t}</option>`).join("")}
      </select>
      <button onclick="prepareMultiTrade()">進行多換多</button>`;
    document.getElementById("teamSelect").onchange = (e) => showOtherTeam(e.target.value);
  }
    function showOtherTeam(team) {
    const players = otherTeams[team];
    const container = document.getElementById("otherTeam");
    container.innerHTML = `<h2>${team} 球員</h2>
      <form id="multiTradeForm">
        ${players.map((p, i) => `
          <div class="player">
            <div class="player-info">
              <label>
                <input type="checkbox" name="other" value="${i}">
                <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}<br/>💰 ${p.salary}M
              </label>
            </div>
          </div>
        `).join("")}
      </form>
      <div><button onclick="prepareMultiTrade('${team}')">換多人</button></div>`;
  }

  window.prepareMultiTrade = function(team) {
    const teamHTML = warriors.map((p, i) => `
      <div class="player">
        <div class="player-info">
          <label>
            <input type="checkbox" name="mine" value="${i}">
            <strong>${p.name}</strong>｜${p.rating}｜${ratingStars(p.rating)}<br/>💰 ${p.salary}M
          </label>
        </div>
      </div>
    `).join("");
    document.getElementById("team").innerHTML = `<h2>勇士出的人選</h2>
      <form id="multiTradeMineForm">${teamHTML}</form>
      <button onclick="submitMultiTrade('${team}')">確認交易</button>`;
  }

  window.submitMultiTrade = function(team) {
    const otherForm = document.getElementById("multiTradeForm");
    const mineForm = document.getElementById("multiTradeMineForm");
    const otherIndices = Array.from(otherForm.querySelectorAll("input[name='other']:checked")).map(i => parseInt(i.value));
    const mineIndices = Array.from(mineForm.querySelectorAll("input[name='mine']:checked")).map(i => parseInt(i.value));

    if (otherIndices.length === 0 || mineIndices.length === 0) {
      alert("請選擇雙方球員！");
      return;
    }

    const fromOther = otherIndices.map(i => otherTeams[team][i]);
    const fromMine = mineIndices.map(i => warriors[i]);

    // 基本的交易邏輯（可以再加上薪資平衡檢查）
    warriors = warriors.filter((_, i) => !mineIndices.includes(i)).concat(fromOther);
    otherTeams[team] = otherTeams[team].filter((_, i) => !otherIndices.includes(i)).concat(fromMine);

    alert("交易完成！");
    saveData();
    showWarriors();
    showOtherTeam(team);
  }
    function simulateGame() {
    const today = new Date().toLocaleDateString();
    if (lastSimDate === today) {
      alert("今天已模擬過一場比賽！");
      return;
    }

    const score = warriors.reduce((sum, p) => sum + ratingMap[p.rating] + Math.floor(Math.random() * 5), 0);
    const [teamName, players] = Object.entries(otherTeams)[Math.floor(Math.random() * Object.keys(otherTeams).length)];
    const oppScore = players.reduce((sum, p) => sum + ratingMap[p.rating] + Math.floor(Math.random() * 5), 0);
    const result = document.getElementById("gameResult");

    result.innerHTML = `<h2>模擬比賽結果</h2>
      <p>勇士 vs ${teamName}</p>
      <p>比分：${score} - ${oppScore}</p>
      <p>${score > oppScore ? "🎉 勇士勝利！" : "😢 勇士落敗..."}</p>`;

    lastSimDate = today;
    saveData();
    renderDate();
  }

  function resetTraining() {
    warriors.forEach(p => p.trainedToday = false);
    alert("訓練已重置！");
    saveData();
    showWarriors();
  }

  // 初始化
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    renderDate();
    showWarriors();

    document.getElementById("showWarriorsBtn").onclick = showWarriors;
    document.getElementById("showFreeAgentsBtn").onclick = showFreeAgents;
    document.getElementById("selectTeamBtn").onclick = selectTeam;
    document.getElementById("simulateGameBtn").onclick = simulateGame;
    document.getElementById("resetTrainingBtn").onclick = resetTraining;

    document.getElementById("clearBtn").onclick = () => {
      if (confirm("清除所有進度？")) {
        localStorage.removeItem("sj_gm_data");
        location.reload();
      }
    };
  });
})();
</script>
</body>
</html>